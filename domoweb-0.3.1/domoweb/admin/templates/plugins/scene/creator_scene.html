{% load i18n %}
<script type='text/javascript'>
    $(function(){
        var test1_visible
        var value1_visible
        var feature2_visible
        var test2_visible
        var value2_visible
        var test_visible
        var TvalueVrai
        var TvalueFaux
        var Tvalue1
        var Tvalue2

        var tableau = new Array();

        $("#Creator").click(function(){ 
             rinor_ip = "{{ request.session.rinor_ip }}";
             rinor_port = "{{ request.session.rinor_port }}";
             description = ""
             if($('select#features1').val() != 0){
                    device1d = tableau[$("select#features1").val()][7]+"-"+tableau[$("select#features1").val()][6];
                    device1adr = tableau[$("select#features1").val()][4];
                    device1id = tableau[$("select#features1").val()][0];
                    device1tech = tableau[$("select#features1").val()][2];
                    debut1 = device1tech.split(".");
                    device1tech = debut1[0];
                    device1key = tableau[$("select#features1").val()][1];
                    }else{
                    device1d='';
                    device1adr = '';
                    device1id = '';
                    device1tech = '';
                    device1key = '';
                    }
              if(features2_visible == true && $('select#features2').val() != 0){
                    device2d= tableau[$("select#features2").val()][7]+"-"+tableau[$("select#features2").val()][6];
                    device2adr = tableau[$("select#features2").val()][4];
                    device2id = tableau[$("select#features2").val()][0];
                    device2tech = tableau[$("select#features2").val()][2];
                    debut2 = device2tech.split(".");
                    device2tech = debut2[0];
                    device2key = tableau[$("select#features2").val()][1];
              }else{
                    device2d = '';
                    device2adr = '';
                    device2id = '';
                    device2tech = '';
                    device2key = '';
              }
              if(test1_visible == true && $("select#test1").val() != 0){
                   optest1= $("select#test1").val();
              }else{
                    optest1 = '';
              }

              device1val='';
              if (Tvalue1 == 'Val'){
                 device1val= $("#Test_value1").val();
               }
              if (Tvalue1 =='Select'){
                 device1val = $("select#Test_value1").val();
               }

              device2val='';
              if (Tvalue2 == 'Val'){
                 device2val= $("#Test_value2").val();
               }
              if (Tvalue2 =='Select'){
                 device2val=$("select#Test_value2").val();
               }

              if(test2_visible == true && $("select#test2").val() != 0){
                   optest2= $("select#test2").val();
              }else{
                    optest2 = '';
              }
              if($("select#TestFeature").val() != 'None'){
                   optest= $("select#TestFeature").val();
              }else{
                    optest = '';
              }
              if( $("select#sortieVrai").val() != 0 &&  $("select#sortieVrai").val() !='command'){
                   actiontrueadr = tableau[$("select#sortieVrai").val()][4];
                   actiontruetech = tableau[$("select#sortieVrai").val()][2];
                   debuttrue = actiontruetech.split(".");
                   actiontruetech = debuttrue[0];
                   test =  tableau[$("select#sortieVrai").val()][5]; 
                   test = test.replace(/&quot;/g,"'");
                   test = test.replace(/{/g,"");
                   test = test.replace(/}/g,"");
                   test = test.replace(/:/g,",");
                   test = test.replace(/'/g,"");
                   test = test.split(',');
                   actiontruecmd = test[1];
              }else{
                   actiontrueadr = '';
                   actiontruetech = '';
                   actiontruecmd = '';
              }
              if ( $("select#sortieVrai").val() == 'command'){
                 actiontrueadr = 'command'
                 actiontruetech = 'command'
                 actiontruecmd = 'command'
              }

              if( $("select#sortieFaux").val() != 0 && $("select#sortieFaux").val() != 'command' ){
                   actionfalseadr = tableau[$("select#sortieFaux").val()][4];
                   actionfalsetech = tableau[$("select#sortieFaux").val()][2];
                   debutfalse = actionfalsetech.split(".");
                   actionfalsetech = debutfalse[0];
                   test = tableau[$("select#sortieFaux").val()][5]; 
                   test = test.replace(/&quot;/g,"'");
                   test = test.replace(/{/g,"");
                   test = test.replace(/}/g,"");
                   test = test.replace(/:/g,",");
                   test = test.replace(/'/g,"");
                   test = test.split(',');
                   actionfalsecmd = test[1]

              }else{
                   actionfalseadr = '';
                   actionfalsetech = '';
                   actionfalsecmd = '';
              }
              if ( $("select#sortieFaux").val() == 'command'){
                 actionfalseadr = 'command'
                 actionfalsetech = 'command'
                 actionfalsecmd = 'command'
              }


              actionfalseval = ''
              actiontrueval = ''
              if( TvalueFaux == 'Val'){
                  actionfalseval = $("#valueFaux").val();
                  actionfalseval = actionfalseval.replace(/,/g,"%#");
              }
              if (TvalueFaux == 'Select'){
                  actionfalseval = $("select#valueFaux").val();;
              }
              if( TvalueVrai == 'Val'){
                  actiontrueval = $("#valueVrai").val();
                  actiontrueval = actiontrueval.replace(/,/g,"%#");
              }
              if (TvalueVrai == 'Select'){
                  actiontrueval = $("select#valueVrai").val();;
              }
              if ($("input#optionstart:checked").val()=="start"){
                  option_start= "true"
              }else{
                  option_start= "false"
              }
              if ($("select#sortieVrai").val()!=0 && $("select#sortieVrai").val() != 'command' ){
                   actriontru= tableau[$("select#sortieVrai").val()][7]+"-"+tableau[$("select#sortieVrai").val()][6]
              }else{
                   actriontru="None"
              }
              if ($("select#sortieVrai").val() == 'command'){
                   actriontru=''
               } 
              if ($("select#sortieFaux").val()!=0 &&$("select#sortieFaux").val() != 'command' ){
                  actrionfal= tableau[$("select#sortieFaux").val()][7]+"-"+tableau[$("select#sortieFaux").val()][6]
              }else{
                  actrionfal="None"
              }
              if ($("select#sortieFaux").val() == 'command'){
                   actrionfal=''
               }

              description="if "+device1d+optest1+device1val+" "+optest +" "+device2d+optest2+device2val+" then "+actriontru+ " "+actiontrueval+" else "+actrionfal+" "+actionfalseval;

                    value="{'device1adr':"+device1adr+",'device1id':"+device1id+",'device1tech':"+device1tech+",'device1key':"+device1key+",'device2adr':"+device2adr+",'device2id':"+device2id+",'device2tech':"+device2tech+",'device2key':"+device2key+",'device1op':"+optest1+",'device2op':"+optest2+",'device1val':"+device1val+",'device2val':"+device2val+",'opglobal':"+optest+",'actiontruetech':"+actiontruetech+",'actionfalsetech':"+actionfalsetech+",'actiontrueadr':"+actiontrueadr+",'actionfalseadr':"+actionfalseadr+",'actiontruecmd':"+actiontruecmd+",'actionfalsecmd':"+actionfalsecmd+",'actiontrueval':"+actiontrueval+",'actionfalseval':"+actionfalseval+",'rinorip':"+rinor_ip+",'rinorport':"+rinor_port+",'option_start':"+option_start+",'descrip':"+description+"}" 

                 rinor.put(['api', 'command', 'scene', '0'], {"command":"Create", 'value':value})
                    .done(function(data, status, xhr){
                         test=JSON.stringify(data);
                         debut=test.search('data=');
                         test=test.slice(debut+4);
                         fin=test.search('}');
                         test=test.slice(1,fin-2);
                         if (test.search('Error')>=0){
                            $.notification('error', test);
                         }else{
                         $.notification('info',test );
                         }
                    })
                    .fail(function(jqXHR, status, error){
                        if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ")");
                    });
                  
               });

        $("select#features1").change(function(){
          var test = $(this).val();
          var test2 = $("select#TestFeature").val();
          if (test !='0'){
          if ((tableau[test][3]=="binary"||tableau[test][3]=="list"||tableau[test][3]=="boolean") && (test2!="And" && test2!="Or" && test2!="None")){
             $("select#TestFeature option").remove();
             $("select#TestFeature").append("<option value='None'>----</option>");
             $("select#features2").hide();
             features2_visible = false
             $("select#test2").hide();
             test2_visible = false
             $("#value2").hide();
             value2_visible = false
             test2 = $("select#TestFeature").val();
          }
          if (test != "" && (test2=="And" || test2=="Or"|| test2=="None")){
             $('select#test1 option').remove();
             $('select#test1').show();
             test1_visible = true
             $('select#test1').append("<option value='None'>-----</option>");
             $('select#test1').append("<option value='='>=</option>");
             var feature=$("select#features1").val();
             var type=tableau[test][3];
             if (type=="number"|| type=="range"){
               $('select#test1').append("<option value='>'>></option>");
               $('select#test1').append("<option value='<'><</option>");
              }
          }else{
             $('select#test1').hide();
             test1_visible = false
             $('#value1').hide();
             value1_visible = false
          }
          $("select#test1").change();
        }
        });    

        $("select#features2").change(function(){
          var test = $(this).val();
          var test2 = $("select#TestFeature").val();
          if (test != "" && (test2=="And" || test2=="Or")){
             $('select#test2').show();
             test2_visible= true
          }else{
             test2_visible= false
             $('select#test2').hide();
             test2_visible = false
             $('#value2').hide();
             value2_visible = false
          }
          $("select#test2").change();
        });    

        $("select#test1").change(function(){
           var test = $("select#features1").val();
           if (tableau[test][3]=="list"||tableau[test][3]=="binary"||tableau[test][3]=="boolean"){
              Tvalue1 = 'Select'
              $('select#test1').attr("disabled", true);
              $('select#test1 option[value="="]').attr("selected", "selected");
              $("#value1").html("<select id='Test_value1' style='width:20em;'></select>");
              $("select#TestFeature option").remove();
              $("select#TestFeature").append("<option value='None'>----</option>");
              $("select#TestFeature").append("<option value='And'>And</option>");
              $("select#TestFeature").append("<option value='Or'>Or</option>");
              var valeur = tableau[test][5];
              var test2 = tableau[test][3];
              valeur = valeur.replace(/&quot;/g,'"');
              var obj = jQuery.parseJSON(valeur);
              if (test2 == "binary"||test2=="boolean"){
                 $("select#Test_value1").append("<option value='"+obj.value0+"'>"+obj.value0+"</option>");
                 $("select#Test_value1").append("<option value='"+obj.value1+"'>"+obj.value1+"</option>");
              }else{
                 for(i=0 ;i<obj.commandValues.length;i++){
                    $("select#Test_value1").append("<option value='"+obj.commandValues[i]+"'>"+obj.commandValues[i]+"</option>");
                 }
            }
            $("#value1").show();
            value1_visible = true
          }else {
             Tvalue1 = 'Val'
             $('select#test1').removeAttr("disabled");
             $("#value1").html("<input id='Test_value1' style='width:20em;'></input>");
             $("#value1").show();
             value1_visible = true
             $("select#TestFeature option").remove();
             $("select#TestFeature").append("<option value='None'>----</option>");
             $("select#TestFeature").append("<option value='And'>And</option>");
             $("select#TestFeature").append("<option value='Or'>Or</option>");
             $("select#TestFeature").append("<option value='='>=</option>");
             $("select#TestFeature").append("<option value='>'>></option>");
             $("select#TestFeature").append("<option value='<'><</option>");
          }
          if ($(this).val()!="None" && ($("select#TestFeature").val()=="And" ||$("select#TestFeature").val()=="Or"   ||$("select#TestFeature").val()=="None")){
             $("#value1").show();
             value1_visible = true
          }else{
               $("#value1").hide();
               value1_visible = false
          }
        });

        $("select#test2").change(function(){
          var test = $("select#features2").val();
          if ((tableau[test][3]=="list"||tableau[test][3]=="binary"||tableau[test][3]=="boolean")&&($("select#TestFeature").val!="None")){ 
            Tvalue2 = 'Select'
            $('select#test2').attr("disabled", true);
            $('select#test2 option[value="="]').attr("selected", "selected");
            $("#value2").html("<select id='Test_value2' style='width:20em;'></select>");
            
            var valeur = tableau[test][5];
            var test2 = tableau[test][3];
            valeur = valeur.replace(/&quot;/g,'"');
            var obj = jQuery.parseJSON(valeur);
            if (test2 == "binary"||test2=="boolean"){
             $("select#Test_value2").append("<option value='"+obj.value0+"'>"+obj.value0+"</option>");
             $("select#Test_value2").append("<option value='"+obj.value1+"'>"+obj.value1+"</option>");
             }
             else{
              for(i=0 ;i<obj.commandValues.length;i++){
             $("select#Test_value2").append("<option value='"+obj.commandValues[i]+"'>"+obj.commandValues[i]+"</option>");
             }}
            $("#value2").show();
            value2_visible = true
          }
          else {
            Tvalue2 = 'Val'
            $('select#test2').removeAttr("disabled");
            $("#value2").html("<input id='Test_value2' style='width:20em;'></input>");
            $("#value2").show();
            value2_visible = true
          }
          
          if ($(this).val()!="None" && ($("select#TestFeature").val()=="And" ||$("select#TestFeature").val()=="Or"   ||$("select#TestFeature").val()=="None")){
             $("#value2").show();
             value2_visible = true
          }else{
             $("#value2").hide();
             value2_visible = false
          }
        });

        $("select#TestFeature").change(function(){
          var test= $("select#TestFeature").val();
          if (test != "None"){
             $("select#features2").show();
             features2_visible = true
             if (test !="And" && test != "Or"){
                $("select#test1").hide();
                test1_visible = false
                $("#value1").hide();
                value1_visible = false
                $("select#test2").hide();
                test2_visible = false
                $("#value2").hide();
                value2_visible = false
                $("select#features2 option").remove();
                var feature1= $("select#features1").val();
                var taille=tableau.length;
                feature1=parseInt(feature1);
                for(i=1;i<tableau.length;i++){
                   var tab=tableau[i];
                   if (tableau[i][3]=="number"||tableau[i][3]=="range"){
                      if (i!=$("select#features1").val()){
                         $("select#features2").append("<option value='"+i+"'>"+tableau[i][8]+" - "+tableau[i][7]+"</option>");
                      }                
                   }  
                  }                
              }else{
                $("select#features2 option").remove();
                $("select#features2").append($("select#features1").clone().html());
                $("select#test1").show();
                test1_visible = true
                $("#value1").show();
                value1_visible = true
                $("select#test2").show();
                test2_visible = true
                $("select#test2").change();
             }
             $("select#features2").change();
          }else{
             $("select#features2").hide();
             features2_visible = false
             $("select#test2").hide();
             test2_visible = false
             $("#value2").hide();
             value2_visible = false
          }
        });

      $("select#sortieVrai").change(function () {
          var test = $("select#sortieVrai").val();
          if (test == "command") {
              TvalueVrai = 'Val'
              $("#valvrai").html("<input id='valueVrai' style='width:20em;'></input>");
          } else {

              var valeur = tableau[test][5];
              var test2 = tableau[test][3];
              valeur = valeur.replace(/&quot;/g, '"');
              var obj = jQuery.parseJSON(valeur);

              if (tableau[test][3] == "list" || tableau[test][3] == "binary"||tableau[test][3]=="boolean") {
                  TvalueVrai = 'Select'
                  $("#valvrai").html("<select id='valueVrai' style='width:20em;'></select>");
                  if (test2 == "binary"||test2=="boolean") {
                      $("select#valueVrai").append("<option value='" + obj.value0 + "'>" + obj.value0 + "</option>");
                      $("select#valueVrai").append("<option value='" + obj.value1 + "'>" + obj.value1 + "</option>");
                  } else {
                      for (i = 0; i < obj.commandValues.length; i++) {
                          $("select#valueVrai").append("<option value='" + obj.commandValues[i] + "'>" + obj.commandValues[i] + "</option>");
                      }
                  }
              }
              if (test2 == "numeric" || test2 == "range") {
                  TvalueVrai = 'Val'
                  $("#valvrai").html("<input id='valueVrai' style='width:20em;'></input>");
              }
              if (test2 == "trigger") {
                  $("#valvrai").html("");
              }
          }
      });


    $("select#sortieFaux").change(function () {
        var test = $("select#sortieFaux").val();
        if (test == 'command') {
            $("#valfaux").html("<input id='valueFaux' style='width:20em;'></input>");
            TvalueFaux = 'Val'
        } else {
            valeur = tableau[test][5];
            var test2 = tableau[test][3];
            valeur = valeur.replace(/&quot;/g, '"');
            var obj = jQuery.parseJSON(valeur);

            if (tableau[test][3] == "list" || tableau[test][3] == "binary"||tableau[test][3]=="boolean") {
                TvalueFaux = 'Select'
                $("#valfaux").html("<select id='valueFaux' style='width:20em;'></select>");
                if (test2 == "binary"||test2=="boolean") {
                    $("select#valueFaux").append("<option value='" + obj.value0 + "'>" + obj.value0 + "</option>");
                    $("select#valueFaux").append("<option value='" + obj.value1 + "'>" + obj.value1 + "</option>");
                } else {
                    for (i = 0; i < obj.commandValues.length; i++) {
                        $("select#valueFaux").append("<option value='" + obj.commandValues[i] + "'>" + obj.commandValues[i] + "</option>");
                    }
                }
            }
            if (test2 == "numeric" || test2 == "range") {
                $("#valfaux").html("<input id='valueFaux' style='width:20em;'></input>");
                TvalueFaux = 'Val'
            }
            if (test2 == "trigger") {
                $("#valfaux").html("");
           } 
        }
     });


      $(document).ready(function(){
        var i=1;
        $('select#features1').append("<option value='0'>----------</option>");
        $('select#sortieVrai').append("<option value='0'>----------</option>");
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
                    tableau[i]=[object.device_id,object.device_feature_model.stat_key,object.device.device_type_id,object.device_feature_model.value_type,object.device.address,object.device_feature_model.parameters,object.device_feature_model.name,object.device.name];
                    if (object.device_feature_model.feature_type == "actuator"){
                       $('select#sortieVrai').append("<option value='"+i+"'>"+object.device.name+" - "+object.device_feature_model.name+"</option>");
                    }
                    if (object.device_feature_model.name != "Trigger"){
                       $('select#features1').append("<option value='"+i+"'>"+object.device.name+" - "+object.device_feature_model.name+"</option>");
                    }
                    i=i+1;
                    });
                
         
                $("select#sortieFaux").append($("select#sortieVrai").clone().html());
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Device list not retrieved" %} (" + jqXHR.responseText + ")");
            });
          $('select#sortieVrai').append("<option value='command'>command line</option>");
          $("select#features2").hide();
          features2_visible = false
          $("select#test2").hide();
          test2_visible = false
          $("select#features1").change();
     });
});

</script>
<section class="subsection">
    <h2>{% trans "Created Scene" %}</h2>
    <h3>{% trans "If" %}</h3>   
    <div>
    <select id="features1" class='listes' style="width:30em;"></select>
    <select id="test1" class='listes' style="width:10em;">
    <option value="None">----</option>
    <option value=">">></option>
    <option value="<"><</option>
    <option value="=">=</option>
    </select>
    <span id="value1"></span>
    </div>
    <div>
    <select id="TestFeature" class='listes' style="width:10em;">
    <option value="None">----</option>
    <option value="And">And</option>
    <option value="Or">Or</option>
    </select>
    </div>
    <div>
    <select id="features2" class='listes' style="width:30em;"></select>
    <select id="test2" class='listes' style="width:10em;">
    <option value="None">None</option>
    <option value=">">></option>
    <option value="<"><</option>
    <option value="=">=</option>
    </select>
    <span id="value2" style="width:30em;"></span>
    </div>
    <div>
    <h3>{% trans "then" %}</h3>
    <select id="sortieVrai" class='listes' style="width:30em;"></select> =>
    <span id="valvrai"></span>
    <h3>{% trans "else" %}</h3>
    <select id="sortieFaux" class='listes' style="width:30em;"></select> =>
    <span id="valfaux"></span>
    </div>
    <input type="checkbox" id="optionstart" checked="checked" value="start" /><label for="optionstart">{% trans "Automaticaly start the scene" %}</label> 
    <button id="Creator" class='button icon16-action-save' style="width:20em;">{% trans "Create" %}</button>
    Rinor Url :{{ request.session.rinor_ip }}:{{ request.session.rinor_port }}</p> 
</section>
